name: Android CI (Self-Hosted, System Gradle, Proxy-Friendly)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: self-hosted

    env:
      ANDROID_HOME: /home/eric/android-sdk
      HTTP_PROXY: http://127.0.0.1:7890
      HTTPS_PROXY: http://127.0.0.1:7890

    steps:
    - uses: actions/checkout@v3

    - name: Build debug APK
      env:
        GRADLE_USER_HOME: ${{ runner.temp }}/gradle
      run: |
        ./gradlew app:assembleDebug
        mv app/build/outputs/apk/debug/app-debug.apk app/build/ChromeXt_debug.apk

    - name: Build release APK (unsigned)
      env:
        GRADLE_USER_HOME: ${{ runner.temp }}/gradle
      run: |
        ./gradlew app:assembleRelease
        mv app/build/outputs/apk/release/app-release-unsigned.apk app/build/ChromeXt_release_unsigned.apk

    - name: Upload debug APK
      uses: actions/upload-artifact@v3
      with:
        name: ChromeXt_debug.apk
        path: app/build/ChromeXt_debug.apk

    - name: Upload release APK (unsigned)
      uses: actions/upload-artifact@v3
      with:
        name: ChromeXt_release_unsigned.apk
        path: app/build/ChromeXt_release_unsigned.apk
